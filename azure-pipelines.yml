# Azure Code Reviewer Pipeline
# Automated code review system using specialized agents
#
# Documentation: docs/DEPLOYMENT.md
# Configuration: Variable Group 'code-review-secrets'
#
# This pipeline executes three specialized review agents:
# - Sentinel: Security vulnerabilities
# - Atlas: Design and UX issues
# - Forge: Code quality and architecture
#
# Results are published as PR comments based on severity threshold

trigger: none

pr:
  branches:
    include:
      - '*'
  paths:
    exclude:
      - 'docs/**'
      - '*.md'
      - 'tests/**'
      - '.github/**'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: code-review-secrets
  - name: INLINE_SEVERITY_THRESHOLD
    value: 'high'
  - name: PYTHON_VERSION
    value: '3.11'

stages:
  - stage: Validation
    displayName: 'Configuration Validation'
    jobs:
      - job: ValidateSetup
        displayName: 'Validate Environment'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(PYTHON_VERSION)'
            inputs:
              versionSpec: '$(PYTHON_VERSION)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'

          - script: |
              python scripts/validate_setup.py
            displayName: 'Validate Configuration'
            env:
              ANTHROPIC_API_KEY: $(ANTHROPIC_API_KEY)

  - stage: CodeReview
    displayName: 'Automated Code Review'
    dependsOn: Validation
    condition: succeeded()
    jobs:
      - job: SecurityReview
        displayName: 'Security Review (Sentinel)'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(PYTHON_VERSION)'
            inputs:
              versionSpec: '$(PYTHON_VERSION)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'

          - script: |
              python scripts/agents/run_security_review.py \
                --base-branch origin/$(System.PullRequest.TargetBranch) \
                --output findings/security.json \
                --save-raw
            displayName: 'Run Security Review (Sentinel)'
            env:
              ANTHROPIC_API_KEY: $(ANTHROPIC_API_KEY)
              LLM_PROVIDER: $(LLM_PROVIDER)

          - publish: findings/security.json
            artifact: security-findings
            displayName: 'Publish Security Findings'

      # Design Review temporarily disabled (no frontend code yet)
      # - job: DesignReview
      #   displayName: 'Design Review (Atlas)'
      #   dependsOn: SecurityReview

      - job: CodeQualityReview
        displayName: 'Code Quality Review (Forge)'
        dependsOn: SecurityReview
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(PYTHON_VERSION)'
            inputs:
              versionSpec: '$(PYTHON_VERSION)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'

          - script: |
              python scripts/agents/run_code_review.py \
                --repo . \
                --target-branch origin/$(System.PullRequest.TargetBranch) \
                --output findings/code.json
            displayName: 'Run Code Quality Review (Forge)'
            env:
              ANTHROPIC_API_KEY: $(ANTHROPIC_API_KEY)
              LLM_PROVIDER: $(LLM_PROVIDER)

          - publish: findings/code.json
            artifact: code-findings
            displayName: 'Publish Code Findings'

  - stage: Normalize
    displayName: 'Normalize Results'
    dependsOn: CodeReview
    condition: succeeded()
    jobs:
      - job: NormalizeFindings
        displayName: 'Consolidate and Deduplicate'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(PYTHON_VERSION)'
            inputs:
              versionSpec: '$(PYTHON_VERSION)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'

          - download: current
            artifact: security-findings
            displayName: 'Download Security Findings'

          - download: current
            artifact: code-findings
            displayName: 'Download Code Findings'

          # Design findings (optional, may not exist if disabled)
          - script: |
              if [ -d "$(Pipeline.Workspace)/design-findings" ]; then
                echo "Design findings available"
              else
                echo "Design findings not available (agent disabled)"
                mkdir -p $(Pipeline.Workspace)/design-findings
                echo '[]' > $(Pipeline.Workspace)/design-findings/design.json
              fi
            displayName: 'Check Design Findings'

          - script: |
              python scripts/normalize_results.py \
                --security-file $(Pipeline.Workspace)/security-findings/security.json \
                --code-file $(Pipeline.Workspace)/code-findings/code.json \
                --design-file $(Pipeline.Workspace)/design-findings/design.json \
                --output reviewResult.json \
                --similarity-threshold 0.80 \
                --stats
            displayName: 'Normalize and Deduplicate Findings'

          - publish: reviewResult.json
            artifact: review-result
            displayName: 'Publish Normalized Results'

  - stage: PublishResults
    displayName: 'Publish to Pull Request'
    dependsOn: Normalize
    condition: succeeded()
    jobs:
      - job: PublishComments
        displayName: 'Create PR Comments'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(PYTHON_VERSION)'
            inputs:
              versionSpec: '$(PYTHON_VERSION)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'

          - download: current
            artifact: review-result
            displayName: 'Download Review Results'

          - script: |
              mkdir -p findings
              cp $(Pipeline.Workspace)/review-result/reviewResult.json findings/reviewResult.json
              echo "Review results copied to findings/"
            displayName: 'Prepare Review Results'

          - script: |
              python scripts/publish_to_pr.py
            displayName: 'üìù Publish Review to PR'
            env:
              SYSTEM_ACCESSTOKEN: $(System.AccessToken)
              INLINE_SEVERITY_THRESHOLD: $(INLINE_SEVERITY_THRESHOLD)
              REVIEW_RESULTS_PATH: findings/reviewResult.json