# Azure Code Reviewer Pipeline
# Automated code review system using specialized agents
#
# Documentation: docs/DEPLOYMENT.md
# Configuration: Variable Group 'code-review-secrets'
#
# This pipeline executes three specialized review agents:
# - Sentinel: Security vulnerabilities
# - Atlas: Design and UX issues
# - Forge: Code quality and architecture
#
# Results are published as PR comments based on severity threshold

trigger: none

pr:
  branches:
    include:
      - '*'
  paths:
    exclude:
      - 'docs/**'
      - '*.md'
      - 'tests/**'
      - '.github/**'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: code-review-secrets
  - name: INLINE_SEVERITY_THRESHOLD
    value: 'high'
  - name: PYTHON_VERSION
    value: '3.11'

stages:
  - stage: Validation
    displayName: 'Configuration Validation'
    jobs:
      - job: ValidateSetup
        displayName: 'Validate Environment'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(PYTHON_VERSION)'
            inputs:
              versionSpec: '$(PYTHON_VERSION)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'

          - script: |
              python scripts/validate_setup.py
            displayName: 'Validate Configuration'
            env:
              ANTHROPIC_API_KEY: $(ANTHROPIC_API_KEY)

  - stage: CodeReview
    displayName: 'Automated Code Review'
    dependsOn: Validation
    condition: succeeded()
    jobs:
      - job: SecurityReview
        displayName: 'Security Review (Sentinel)'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(PYTHON_VERSION)'
            inputs:
              versionSpec: '$(PYTHON_VERSION)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'

          - script: |
              python scripts/agents/run_security_review.py \
                --base-branch origin/$(System.PullRequest.TargetBranch) \
                --output findings/security.json \
                --save-raw
            displayName: 'Run Security Review (Sentinel)'
            env:
              ANTHROPIC_API_KEY: $(ANTHROPIC_API_KEY)
              LLM_PROVIDER: $(LLM_PROVIDER)

          - publish: findings/security.json
            artifact: security-findings
            displayName: 'Publish Security Findings'

      # Design Review temporarily disabled (no frontend code yet)
      # - job: DesignReview
      #   displayName: 'Design Review (Atlas)'
      #   dependsOn: SecurityReview

      - job: CodeQualityReview
        displayName: 'Code Quality Review (Forge)'
        dependsOn: SecurityReview
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(PYTHON_VERSION)'
            inputs:
              versionSpec: '$(PYTHON_VERSION)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'

          - script: |
              python scripts/agents/run_code_review.py \
                --repo . \
                --target-branch origin/$(System.PullRequest.TargetBranch) \
                --output findings/code.json
            displayName: 'Run Code Quality Review (Forge)'
            env:
              ANTHROPIC_API_KEY: $(ANTHROPIC_API_KEY)
              LLM_PROVIDER: $(LLM_PROVIDER)

          - publish: findings/code.json
            artifact: code-findings
            displayName: 'Publish Code Findings'

  - stage: Normalize
    displayName: 'Normalize Results'
    dependsOn: CodeReview
    condition: succeeded()
    jobs:
      - job: NormalizeFindings
        displayName: 'Consolidate and Deduplicate'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(PYTHON_VERSION)'
            inputs:
              versionSpec: '$(PYTHON_VERSION)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'

          - download: current
            artifact: security-findings

          - download: current
            artifact: design-findings

          - download: current
            artifact: code-findings

          - script: |
              echo "Normalization will be implemented in Phase 4"
              echo "Consolidating findings from all agents..."
              mkdir -p findings
              echo '{"summary": {"total": 0, "critical": 0, "high": 0, "medium": 0, "low": 0}, "findings": []}' > reviewResult.json
            displayName: 'Normalize Results'

          - publish: reviewResult.json
            artifact: review-result
            displayName: 'Publish Normalized Results'

  - stage: PublishResults
    displayName: 'Publish to Pull Request'
    dependsOn: Normalize
    condition: succeeded()
    jobs:
      - job: PublishComments
        displayName: 'Create PR Comments'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(PYTHON_VERSION)'
            inputs:
              versionSpec: '$(PYTHON_VERSION)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install Dependencies'

          - download: current
            artifact: review-result

          - script: |
              echo "PR publishing will be implemented in Phase 5"
              echo "PR ID: $(System.PullRequest.PullRequestId)"
              echo "Threshold: $(INLINE_SEVERITY_THRESHOLD)"
              echo "Repository: $(Build.Repository.Name)"
            displayName: 'Publish to Pull Request'
            env:
              AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)
              INLINE_SEVERITY_THRESHOLD: $(INLINE_SEVERITY_THRESHOLD)