# Azure DevOps Pipeline - Automated Code Review System
# Triggers on every PR update to provide continuous feedback

trigger: none  # Only run on PRs

pr:
  branches:
    include:
      - '*'  # All branches

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: code-review-secrets  # Contains ANTHROPIC_API_KEY
  - name: INLINE_SEVERITY_THRESHOLD
    value: 'high'  # Options: critical | high | medium | all
  - name: PYTHON_VERSION
    value: '3.11'

stages:
  - stage: CodeReview
    displayName: 'Automated Code Review'
    jobs:
      - job: RunReviewAgents
        displayName: 'Execute Review Agents'
        timeoutInMinutes: 10

        steps:
          - task: UsePythonVersion@0
            displayName: 'Set up Python $(PYTHON_VERSION)'
            inputs:
              versionSpec: '$(PYTHON_VERSION)'
              addToPath: true

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              echo "üìä Starting code review for PR #$(System.PullRequest.PullRequestId)"
              echo "Threshold: $(INLINE_SEVERITY_THRESHOLD)"
            displayName: 'Review configuration'

          # TODO: Implement in Phase 2
          # - script: |
          #     python scripts/agents/run_security_review.py \
          #       --pr-id $(System.PullRequest.PullRequestId) \
          #       --output findings/security.json
          #   displayName: 'üõ°Ô∏è Security Review (Sentinel)'
          #   env:
          #     ANTHROPIC_API_KEY: $(ANTHROPIC_API_KEY)

          # TODO: Implement in Phase 3
          # - script: |
          #     python scripts/agents/run_design_review.py \
          #       --pr-id $(System.PullRequest.PullRequestId) \
          #       --output findings/design.json
          #   displayName: 'üé® Design Review (Atlas)'
          #   env:
          #     ANTHROPIC_API_KEY: $(ANTHROPIC_API_KEY)

          # - script: |
          #     python scripts/agents/run_code_review.py \
          #       --pr-id $(System.PullRequest.PullRequestId) \
          #       --output findings/code.json
          #   displayName: 'üß† Code Review (Forge)'
          #   env:
          #     ANTHROPIC_API_KEY: $(ANTHROPIC_API_KEY)

          # TODO: Implement in Phase 4
          # - script: |
          #     python scripts/normalize_results.py \
          #       --input-dir findings/ \
          #       --output reviewResult.json
          #   displayName: 'üîÑ Normalize findings'

          # TODO: Implement in Phase 5
          # - script: |
          #     python scripts/publish_to_pr.py \
          #       --review-file reviewResult.json \
          #       --pr-id $(System.PullRequest.PullRequestId) \
          #       --org $(System.CollectionUri) \
          #       --project $(System.TeamProject) \
          #       --repo $(Build.Repository.ID) \
          #       --inline-threshold $(INLINE_SEVERITY_THRESHOLD)
          #   displayName: 'üì§ Publish to PR'
          #   env:
          #     AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)

          - script: |
              echo "‚úÖ Code review pipeline completed"
            displayName: 'Pipeline complete'
